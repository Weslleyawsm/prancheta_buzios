<!DOCTYPE html>
<html>
<head>
    <title>Prancheta de Carros - Com Cron√¥metro</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c5aa0; text-align: center; }

        /* Estilos do Cron√¥metro */
        .cronometro-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .cronometro-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            50% { transform: translate(-50%, -50%) rotate(180deg); }
        }

        .cronometro-titulo {
            font-size: 18px;
            margin-bottom: 10px;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .cronometro-display {
            font-size: 48px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        .cronometro-info {
            font-size: 16px;
            opacity: 0.8;
            margin-top: 10px;
            position: relative;
            z-index: 2;
        }

        .cronometro-proximo {
            background-color: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            position: relative;
            z-index: 2;
        }

        .cronometro.atrasado {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            animation: pulse 1s infinite;
        }

        .cronometro.zerado {
            background: linear-gradient(135deg, #00d2d3 0%, #54a0ff 100%);
        }

        .cronometro.aguardando-confirmacao {
            background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);
            animation: pulse 0.8s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .auto-confirmacao {
            background-color: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            position: relative;
            z-index: 2;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .auto-confirmacao h4 {
            margin: 0 0 10px 0;
            color: #fff;
            font-size: 18px;
        }

        .countdown-auto {
            font-size: 24px;
            font-weight: bold;
            color: #ffeb3b;
            margin: 10px 0;
        }

        .controls-cronometro {
            text-align: center;
            margin-top: 15px;
            position: relative;
            z-index: 2;
        }

        .controls-cronometro button {
            margin: 0 5px;
            padding: 8px 15px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-reset { background-color: #ffc107; color: #212529; }
        .btn-reset:hover { background-color: #e0a800; transform: translateY(-2px); }

        .btn-pausar { background-color: #dc3545; color: white; }
        .btn-pausar:hover { background-color: #c82333; transform: translateY(-2px); }

        .btn-iniciar { background-color: #28a745; color: white; }
        .btn-iniciar:hover { background-color: #1e7e34; transform: translateY(-2px); }

        .btn-confirmar { background-color: #007bff; color: white; padding: 12px 20px; font-size: 16px; }
        .btn-confirmar:hover { background-color: #0056b3; transform: translateY(-2px); }

        .secao { margin: 20px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .secao h3 { margin-top: 0; color: #333; }
        input, button, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #2c5aa0; color: white; cursor: pointer; padding: 10px 20px; }
        button:hover { background-color: #1e3d6f; }
        button.finalizar { background-color: #28a745; }
        button.finalizar:hover { background-color: #1e7e34; }
        button.consultar { background-color: #17a2b8; }
        button.consultar:hover { background-color: #117a8b; }
        button.estatisticas { background-color: #ffc107; color: #212529; }
        button.estatisticas:hover { background-color: #e0a800; }
        button.editar { background-color: #fd7e14; font-size: 12px; padding: 5px 10px; }
        button.editar:hover { background-color: #e8590c; }
        button.remover { background-color: #dc3545; font-size: 12px; padding: 5px 10px; }
        button.remover:hover { background-color: #c82333; }
        .lista-carros { background-color: #f9f9f9; }
        .carro-item { padding: 8px; margin: 5px 0; background: white; border-radius: 4px; border-left: 4px solid #2c5aa0; }
        .carro-item.editando { border-left-color: #fd7e14; background-color: #fff3cd; }
        .carro-item.proximo-carro {
            border-left-color: #ff6b6b;
            background-color: #fff5f5;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255,107,107,0.3);
        }
        .carro-item.proximo-carro::before {
            content: '‚è∞ PR√ìXIMO ‚Üí ';
            color: #ff6b6b;
            font-weight: bold;
        }
        .carro-item.carro-saiu {
            border-left-color: #28a745;
            background-color: #f8fff8;
            opacity: 0.7;
        }
        .carro-item.carro-saiu::before {
            content: '‚úÖ SAIU ‚Üí ';
            color: #28a745;
            font-weight: bold;
        }
        .carro-item.proximo-carro::before {
            content: '‚è∞ PR√ìXIMO ‚Üí ';
            color: #ff6b6b;
            font-weight: bold;
        }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .sucesso { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .erro { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .filtros { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .sessao-info { background-color: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .historico-section { background-color: #f8f9fa; }
        .estatisticas-section { background-color: #fff3cd; }
        .tabs { display: flex; margin-bottom: 15px; }
        .tab { padding: 10px 20px; background-color: #e9ecef; border: 1px solid #ddd; cursor: pointer; }
        .tab.active { background-color: #2c5aa0; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .resultado-consulta { max-height: 400px; overflow-y: auto; }
        .estatistica-item { background: white; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #ffc107; }

        /* Estilos para o modal de edi√ß√£o */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: #fd7e14; }
        .fechar-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .fechar-modal:hover { color: #000; }
        .form-editar { display: grid; gap: 10px; }
        .form-editar label { font-weight: bold; }
        .form-editar input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .botoes-modal { display: flex; gap: 10px; margin-top: 20px; }
        .botoes-modal button { flex: 1; }

        /* Estilos para formul√°rio inline de edi√ß√£o */
        .edicao-inline { background-color: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px; }
        .edicao-inline input { margin: 2px; padding: 5px; font-size: 12px; }
        .edicao-inline .botoes-edicao { margin-top: 5px; }
        .edicao-inline .botoes-edicao button { padding: 5px 10px; font-size: 12px; margin: 2px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöå Prancheta de Carros</h1>

        <!-- Cron√¥metro do Pr√≥ximo Carro -->
        <div class="cronometro-container" id="cronometroContainer">
            <div class="cronometro-titulo">‚è∞ Cron√¥metro do Pr√≥ximo Carro</div>
            <div class="cronometro-display" id="cronometroDisplay">--:--</div>
            <div class="cronometro-info" id="cronometroInfo">Aguardando carros...</div>

            <div class="cronometro-proximo" id="proximoCarroInfo" style="display: none;">
                <strong>üöó Carro:</strong> <span id="proximoCarroNumero">--</span> |
                <strong>üë®‚Äçüíº Motorista:</strong> <span id="proximoCarroMotorista">--</span> |
                <strong>üïê Sa√≠da:</strong> <span id="proximoCarroHorario">--:--</span>
            </div>

            <!-- Se√ß√£o de Auto-confirma√ß√£o (aparece quando tempo esgota) -->
            <div class="auto-confirmacao" id="autoConfirmacao" style="display: none;">
                <h4>üö® TEMPO ESGOTADO!</h4>
                <p>Carro deveria ter sa√≠do. Confirma√ß√£o autom√°tica em:</p>
                <div class="countdown-auto" id="countdownAuto">30</div>
                <button onclick="confirmarSaidaCarro()" class="btn-confirmar">‚úÖ Confirmar Sa√≠da Agora</button>
            </div>

            <div class="controls-cronometro">
                <button onclick="pausarCronometro()" class="btn-pausar" id="btnPausar">‚è∏Ô∏è Pausar</button>
                <button onclick="iniciarCronometro()" class="btn-iniciar" id="btnIniciar" style="display: none;">‚ñ∂Ô∏è Continuar</button>
                <button onclick="resetarCronometro()" class="btn-reset">üîÑ Resetar</button>
                <button onclick="confirmarSaidaCarro()" class="btn-iniciar" id="btnConfirmarSaida">‚úÖ Confirmar Sa√≠da</button>
            </div>
        </div>

        <!-- Info da Sess√£o Atual -->
        <div id="sessaoAtual" class="sessao-info" style="display: none;">
            <strong>üìã Sess√£o Atual:</strong> <span id="infoSessao"></span>
            <button onclick="verificarSessao()" style="float: right; padding: 5px 10px; font-size: 12px;">üîÑ</button>
        </div>

        <!-- Se√ß√£o do Cabe√ßalho -->
        <div class="secao">
            <h3>üìã 1. Definir Cabe√ßalho da Prancheta</h3>
            <form id="formCabecalho">
                <input type="text" id="fiscal" name="fiscal" placeholder="Nome do Fiscal" required>
                <input type="date" id="data" name="data" required>
                <input type="text" id="linha" name="linha" placeholder="Linha (ex: Centro-Rodovi√°ria)" required>
                <button type="submit">Definir Cabe√ßalho</button>
            </form>
            <div id="statusCabecalho"></div>
        </div>

        <!-- Se√ß√£o Adicionar Carro -->
        <div class="secao">
            <h3>üöó 2. Adicionar Sa√≠da de Carro</h3>
            <form id="formCarro">
                <input type="text" id="numero" name="numero" placeholder="N√∫mero do Carro" required>
                <input type="text" id="motorista" name="motorista" placeholder="Nome do Motorista" required>
                <input type="time" id="horario" name="horario" required>
                <button type="submit">Adicionar Carro</button>
            </form>
            <div id="statusCarro"></div>
        </div>

        <!-- Lista de Carros da Sess√£o Atual -->
        <div class="secao lista-carros">
            <h3>üìù 3. Carros do Dia Atual</h3>
            <button onclick="carregarCarrosSessao()">üîÑ Atualizar Lista</button>
            <button onclick="finalizarDia()" class="finalizar">üèÅ Finalizar Dia</button>
            <div id="listaCarros">Clique em "Atualizar Lista" para ver os carros...</div>
        </div>

        <!-- Se√ß√£o de Hist√≥rico e Consultas -->
        <div class="secao historico-section">
            <h3>üîç 4. Consultar Hist√≥rico</h3>

            <div class="tabs">
                <div class="tab active" onclick="abrirTab('consulta-simples')">üìÖ Por Data</div>
                <div class="tab" onclick="abrirTab('consulta-avancada')">üîé Filtros Avan√ßados</div>
                <div class="tab" onclick="abrirTab('estatisticas')">üìä Estat√≠sticas</div>
            </div>

            <!-- Consulta por Data Espec√≠fica -->
            <div id="consulta-simples" class="tab-content active">
                <h4>Consultar por Data Espec√≠fica</h4>
                <form id="formConsultaSimples">
                    <input type="date" id="dataConsulta" name="data_especifica" required>
                    <button type="submit" class="consultar">Buscar</button>
                </form>
                <div id="statusConsultaSimples"></div>
                <div id="resultadoConsultaSimples" class="resultado-consulta"></div>
            </div>

            <!-- Consulta Avan√ßada -->
            <div id="consulta-avancada" class="tab-content">
                <h4>Filtros Avan√ßados</h4>
                <form id="formConsultaAvancada">
                    <div class="filtros">
                        <div>
                            <label>Per√≠odo:</label><br>
                            <input type="date" id="dataInicio" name="data_inicio" placeholder="Data In√≠cio">
                            <input type="date" id="dataFim" name="data_fim" placeholder="Data Fim">
                        </div>
                        <div>
                            <label>Outros Filtros:</label><br>
                            <input type="text" id="filtroFiscal" name="fiscal" placeholder="Nome do Fiscal">
                            <input type="text" id="filtroLinha" name="linha" placeholder="Linha">
                        </div>
                        <div>
                            <input type="text" id="filtroNumero" name="numero_carro" placeholder="N√∫mero do Carro">
                            <input type="text" id="filtroMotorista" name="nome_motorista" placeholder="Nome do Motorista">
                        </div>
                    </div>
                    <button type="submit" class="consultar">üîç Buscar com Filtros</button>
                    <button type="button" onclick="limparFiltros()">üóëÔ∏è Limpar</button>
                </form>
                <div id="statusConsultaAvancada"></div>
                <div id="resultadoConsultaAvancada" class="resultado-consulta"></div>
            </div>

            <!-- Estat√≠sticas -->
            <div id="estatisticas" class="tab-content">
                <h4>Estat√≠sticas por Per√≠odo</h4>
                <form id="formEstatisticas">
                    <label>Per√≠odo para Estat√≠sticas:</label><br>
                    <input type="date" id="estatDataInicio" name="data_inicio" required>
                    <input type="date" id="estatDataFim" name="data_fim" required>
                    <button type="submit" class="estatisticas">üìä Gerar Estat√≠sticas</button>
                </form>
                <div id="statusEstatisticas"></div>
                <div id="resultadoEstatisticas"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="modalEdicao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Registro</h3>
                <span class="fechar-modal" onclick="fecharModalEdicao()">&times;</span>
            </div>
            <form id="formEdicao" class="form-editar">
                <input type="hidden" id="editId" name="id">

                <label for="editFiscal">Nome do Fiscal:</label>
                <input type="text" id="editFiscal" name="nome_fiscal" required>

                <label for="editData">Data:</label>
                <input type="date" id="editData" name="data_trabalho" required>

                <label for="editLinha">Linha:</label>
                <input type="text" id="editLinha" name="linha" required>

                <label for="editNumero">N√∫mero do Carro:</label>
                <input type="text" id="editNumero" name="numero_carro" required>

                <label for="editMotorista">Nome do Motorista:</label>
                <input type="text" id="editMotorista" name="nome_motorista" required>

                <label for="editHorario">Hor√°rio de Sa√≠da:</label>
                <input type="time" id="editHorario" name="horario_saida" required>

                <div class="botoes-modal">
                    <button type="button" onclick="fecharModalEdicao()">‚ùå Cancelar</button>
                    <button type="submit" class="editar">‚úÖ Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS DO CRON√îMETRO ==========
        let cronometroAtivo = false;
        let cronometroInterval = null;
        let carroAtual = null;
        let carrosPendentes = [];
        let cronometroPausado = false;
        let autoConfirmacaoAtiva = false;
        let autoConfirmacaoInterval = null;
        let tempoAutoConfirmacao = 30; // 30 segundos para auto-confirma√ß√£o
        let TIMEOUT_CONFIRMACAO = 30; // Pode ser alterado se necess√°rio

        // Definir data atual como padr√£o
        document.getElementById('data').valueAsDate = new Date();
        document.getElementById('dataConsulta').valueAsDate = new Date();

        // Verificar sess√£o atual ao carregar a p√°gina
        window.onload = function() {
            verificarSessao();
            carregarCarrosSessao();
            inicializarCronometro();
        };

        // ========== FUN√á√ïES DO CRON√îMETRO H√çBRIDO ==========

        function inicializarCronometro() {
            console.log('üîß Inicializando cron√¥metro...');
            if (!cronometroAtivo) {
                iniciarCronometro();
            }
        }

        function atualizarListaCarrosPendentes() {
            console.log('üîÑ Atualizando lista de carros pendentes...');

            if (!carrosPendentes || carrosPendentes.length === 0) {
                carroAtual = null;
                document.getElementById('cronometroInfo').textContent = 'Nenhum carro agendado';
                document.getElementById('proximoCarroInfo').style.display = 'none';
                document.getElementById('cronometroDisplay').textContent = '--:--';
                console.log('‚ùå Nenhum carro na lista');
                return;
            }

            const agora = new Date();

            // Ordenar carros por hor√°rio de sa√≠da (mais pr√≥ximo primeiro)
            carrosPendentes.sort((a, b) => {
                const horaA = new Date();
                const [horaAH, horaAM] = a.horario.split(':');
                horaA.setHours(horaAH, horaAM, 0, 0);

                const horaB = new Date();
                const [horaBH, horaBM] = b.horario.split(':');
                horaB.setHours(horaBH, horaBM, 0, 0);

                return horaA - horaB;
            });

            // Definir pr√≥ximo carro
            const novoCarroAtual = carrosPendentes[0];

            if (novoCarroAtual) {
                // S√≥ atualizar se realmente mudou
                if (!carroAtual || carroAtual.id !== novoCarroAtual.id) {
                    carroAtual = novoCarroAtual;
                    console.log('üéØ Novo carro definido:', carroAtual);
                    atualizarInfoProximoCarro();

                    // Resetar estados do cron√¥metro
                    if (autoConfirmacaoInterval) {
                        clearInterval(autoConfirmacaoInterval);
                    }
                    autoConfirmacaoAtiva = false;
                    document.getElementById('autoConfirmacao').style.display = 'none';

                    // Resetar visual
                    const container = document.getElementById('cronometroContainer');
                    container.className = 'cronometro-container';
                }
            } else {
                carroAtual = null;
                document.getElementById('cronometroInfo').textContent = 'Todos os carros sa√≠ram!';
                document.getElementById('proximoCarroInfo').style.display = 'none';
                console.log('‚úÖ Todos os carros sa√≠ram');
            }
        }

        function atualizarInfoProximoCarro() {
            if (!carroAtual) return;

            document.getElementById('proximoCarroNumero').textContent = carroAtual.numero;
            document.getElementById('proximoCarroMotorista').textContent = carroAtual.motorista;
            document.getElementById('proximoCarroHorario').textContent = carroAtual.horario;
            document.getElementById('proximoCarroInfo').style.display = 'block';
        }

        function iniciarCronometro() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
            }

            cronometroAtivo = true;
            cronometroPausado = false;
            document.getElementById('btnPausar').style.display = 'inline-block';
            document.getElementById('btnIniciar').style.display = 'none';

            cronometroInterval = setInterval(atualizarCronometro, 1000);
            atualizarCronometro(); // Atualizar imediatamente
            console.log('‚ñ∂Ô∏è Cron√¥metro iniciado');
        }

        function pausarCronometro() {
            cronometroPausado = true;
            cronometroAtivo = false;
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
            }
            document.getElementById('btnPausar').style.display = 'none';
            document.getElementById('btnIniciar').style.display = 'inline-block';
            console.log('‚è∏Ô∏è Cron√¥metro pausado');
        }

        function resetarCronometro() {
            if (cronometroInterval) {
                clearInterval(cronometroInterval);
            }
            if (autoConfirmacaoInterval) {
                clearInterval(autoConfirmacaoInterval);
            }
            cronometroAtivo = false;
            cronometroPausado = false;
            autoConfirmacaoAtiva = false;
            document.getElementById('autoConfirmacao').style.display = 'none';

            atualizarListaCarrosPendentes();
            iniciarCronometro();
            console.log('üîÑ Cron√¥metro resetado');
        }

        // NOVA FUN√á√ÉO: Confirmar sa√≠da via servidor
        async function confirmarSaidaCarro() {
            if (!carroAtual) {
                console.log('‚ùå Nenhum carro atual para confirmar');
                return;
            }

            console.log('‚úÖ Confirmando sa√≠da do carro:', carroAtual.numero);

            try {
                // ENVIAR CONFIRMA√á√ÉO PARA O SERVIDOR
                const response = await fetch('/confirmar-saida', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `id=${carroAtual.id}`
                });

                const resultado = await response.json();

                if (resultado.status === 'ok') {
                    console.log('‚úÖ Sa√≠da confirmada no servidor para carro ID:', carroAtual.id);

                    // Parar auto-confirma√ß√£o se estiver ativa
                    if (autoConfirmacaoInterval) {
                        clearInterval(autoConfirmacaoInterval);
                        autoConfirmacaoInterval = null;
                    }
                    autoConfirmacaoAtiva = false;
                    document.getElementById('autoConfirmacao').style.display = 'none';

                    // Remover visual de atrasado/confirma√ß√£o
                    const container = document.getElementById('cronometroContainer');
                    container.className = 'cronometro-container';

                    // Guardar ID do carro que est√° saindo
                    const carroSaindoId = carroAtual.id;

                    // Remover da lista de pendentes
                    carrosPendentes = carrosPendentes.filter(c => c.id !== carroSaindoId);
                    console.log('üìù Carros restantes:', carrosPendentes.length);

                    // Feedback visual tempor√°rio
                    document.getElementById('cronometroInfo').textContent = 'Carro saiu! Pr√≥ximo...';
                    document.getElementById('cronometroDisplay').textContent = '‚úÖ OK';
                    document.getElementById('proximoCarroInfo').style.display = 'none';

                    // Definir pr√≥ximo carro imediatamente
                    carroAtual = null; // Limpar primeiro

                    if (carrosPendentes.length > 0) {
                        console.log('üîÑ Definindo pr√≥ximo carro...');
                        setTimeout(() => {
                            atualizarListaCarrosPendentes();
                            if (carroAtual) {
                                console.log('üéØ Pr√≥ximo carro:', carroAtual.numero, carroAtual.horario);
                                atualizarInfoProximoCarro();
                                // For√ßar atualiza√ß√£o do cron√¥metro
                                atualizarCronometro();
                            }
                        }, 1500);
                    } else {
                        // N√£o h√° mais carros
                        console.log('‚úÖ Todos os carros sa√≠ram!');
                        document.getElementById('cronometroInfo').textContent = 'Todos os carros sa√≠ram!';
                        document.getElementById('proximoCarroInfo').style.display = 'none';
                        document.getElementById('cronometroDisplay').textContent = '--:--';
                    }

                    // Atualizar lista visual (n√£o interfere com cron√¥metro)
                    setTimeout(() => {
                        carregarCarrosSessao();
                    }, 500);

                } else {
                    console.log('‚ùå Erro ao confirmar sa√≠da:', resultado.mensagem);
                    alert('‚ùå Erro ao confirmar sa√≠da: ' + resultado.mensagem);
                }

            } catch (error) {
                console.log('‚ùå Erro de comunica√ß√£o:', error);
                alert('‚ùå Erro de comunica√ß√£o: ' + error.message);
            }
        }

        function iniciarAutoConfirmacao() {
            if (autoConfirmacaoAtiva) return; // J√° est√° ativa

            console.log('üö® Iniciando auto-confirma√ß√£o...');
            autoConfirmacaoAtiva = true;
            tempoAutoConfirmacao = TIMEOUT_CONFIRMACAO;

            document.getElementById('autoConfirmacao').style.display = 'block';
            document.getElementById('countdownAuto').textContent = tempoAutoConfirmacao;

            // Mudar visual do cron√¥metro
            const container = document.getElementById('cronometroContainer');
            container.className = 'cronometro-container cronometro aguardando-confirmacao';

            autoConfirmacaoInterval = setInterval(() => {
                tempoAutoConfirmacao--;
                document.getElementById('countdownAuto').textContent = tempoAutoConfirmacao;
                console.log('‚è∞ Auto-confirma√ß√£o countdown:', tempoAutoConfirmacao);

                if (tempoAutoConfirmacao <= 0) {
                    // Auto-confirma√ß√£o autom√°tica!
                    console.log('ü§ñ EXECUTANDO AUTO-CONFIRMA√á√ÉO AUTOM√ÅTICA!');
                    clearInterval(autoConfirmacaoInterval);
                    autoConfirmacaoInterval = null;
                    autoConfirmacaoAtiva = false;
                    document.getElementById('autoConfirmacao').style.display = 'none';

                    // Chamar confirma√ß√£o de sa√≠da
                    confirmarSaidaCarro();
                }
            }, 1000);

            console.log('‚è∞ Auto-confirma√ß√£o iniciada - 30 segundos');
        }

        function atualizarCronometro() {
            if (!carroAtual || cronometroPausado) {
                document.getElementById('cronometroDisplay').textContent = '--:--';
                return;
            }

            const agora = new Date();
            const horarioSaida = new Date();
            const [hora, minuto] = carroAtual.horario.split(':');
            horarioSaida.setHours(hora, minuto, 0, 0);

            const diferenca = horarioSaida.getTime() - agora.getTime();
            const container = document.getElementById('cronometroContainer');

            if (diferenca <= 0) {
                // Hor√°rio passou - mostrar como atrasado
                const diferencaAbs = Math.abs(diferenca);
                const minutosAtraso = Math.floor(diferencaAbs / 60000);
                const segundosAtraso = Math.floor((diferencaAbs % 60000) / 1000);

                document.getElementById('cronometroDisplay').textContent =
                    `+${minutosAtraso.toString().padStart(2, '0')}:${segundosAtraso.toString().padStart(2, '0')}`;
                document.getElementById('cronometroInfo').textContent = 'TEMPO ESGOTADO!';

                container.className = 'cronometro-container cronometro atrasado';

                // Iniciar auto-confirma√ß√£o se ainda n√£o iniciou E se passou mais de 5 segundos
                if (!autoConfirmacaoAtiva && diferencaAbs > 5000) {
                    console.log('üö® Iniciando auto-confirma√ß√£o - tempo esgotado h√°', Math.floor(diferencaAbs/1000), 'segundos');
                    iniciarAutoConfirmacao();
                }

            } else if (diferenca <= 60000) {
                // √öltimo minuto - mostrar segundos
                const segundos = Math.floor(diferenca / 1000);
                document.getElementById('cronometroDisplay').textContent =
                    `00:${segundos.toString().padStart(2, '0')}`;
                document.getElementById('cronometroInfo').textContent = '√öLTIMOS SEGUNDOS!';

                container.className = 'cronometro-container cronometro zerado';
            } else {
                // Tempo normal
                const minutos = Math.floor(diferenca / 60000);
                const segundos = Math.floor((diferenca % 60000) / 1000);

                document.getElementById('cronometroDisplay').textContent =
                    `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
                document.getElementById('cronometroInfo').textContent = 'Tempo restante para sa√≠da';

                container.className = 'cronometro-container';
            }
        }

        // ========== FUN√á√ïES EXISTENTES (adaptadas para cron√¥metro) ==========

        // Fun√ß√£o para verificar sess√£o atual
        async function verificarSessao() {
            try {
                const response = await fetch('/sessao-atual');
                const dados = await response.json();

                const sessaoDiv = document.getElementById('sessaoAtual');
                const infoSpan = document.getElementById('infoSessao');

                if (dados.status === 'ok' && dados.sessao) {
                    sessaoDiv.style.display = 'block';
                    infoSpan.innerHTML = `${dados.sessao.fiscal} | ${dados.sessao.data} | ${dados.sessao.linha} | ${dados.sessao.total_carros} carros`;
                } else {
                    sessaoDiv.style.display = 'none';
                }
            } catch (error) {
                console.log('Erro ao verificar sess√£o:', error);
            }
        }

        // Fun√ß√£o para abrir tabs
        function abrirTab(tabId) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab selecionada
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Fun√ß√£o para enviar cabe√ßalho
        document.getElementById('formCabecalho').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const dados = new URLSearchParams(formData);

            try {
                const response = await fetch('/cabecalho', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: dados
                });

                const resultado = await response.json();

                const statusDiv = document.getElementById('statusCabecalho');
                if (resultado.status === 'ok') {
                    statusDiv.innerHTML = '<div class="status sucesso">‚úÖ ' + resultado.mensagem + '</div>';
                    verificarSessao(); // Atualizar info da sess√£o
                } else {
                    statusDiv.innerHTML = '<div class="status erro">‚ùå ' + resultado.mensagem + '</div>';
                }
            } catch (error) {
                document.getElementById('statusCabecalho').innerHTML = '<div class="status erro">‚ùå Erro: ' + error + '</div>';
            }
        });

        // Fun√ß√£o para adicionar carro
        document.getElementById('formCarro').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const dados = new URLSearchParams(formData);

            try {
                const response = await fetch('/adicionar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: dados
                });

                const resultado = await response.json();

                const statusDiv = document.getElementById('statusCarro');
                if (resultado.status === 'ok') {
                    statusDiv.innerHTML = '<div class="status sucesso">‚úÖ ' + resultado.mensagem + '</div>';
                    // Limpar formul√°rio e atualizar lista
                    e.target.reset();
                    carregarCarrosSessao();
                    verificarSessao(); // Atualizar contador

                    // Atualizar cron√¥metro com novo carro
                    setTimeout(() => {
                        atualizarListaCarrosPendentes();
                    }, 500);
                } else {
                    statusDiv.innerHTML = '<div class="status erro">‚ùå ' + resultado.mensagem + '</div>';
                }
            } catch (error) {
                document.getElementById('statusCarro').innerHTML = '<div class="status erro">‚ùå Erro: ' + error + '</div>';
            }
        });

        // NOVA FUN√á√ÉO: Carregar carros da sess√£o atual (com status de confirma√ß√£o)
        async function carregarCarrosSessao() {
            console.log('üîÑ INICIANDO carregamento de carros...');
            try {
                const response = await fetch('/listar');
                const dados = await response.json();

                console.log('üìä DADOS RECEBIDOS DO SERVIDOR:', dados);

                const listaDiv = document.getElementById('listaCarros');

                if (dados.status === 'ok' && dados.carros.length > 0) {
                    console.log('‚úÖ Processando', dados.carros.length, 'carros...');

                    // FILTRAR carros que N√ÉO foram confirmados para usar no cron√¥metro
                    const carrosNaoConfirmados = dados.carros.filter(carro => !carro.saida_confirmada);
                    console.log('üöó Carros N√ÉO confirmados:', carrosNaoConfirmados.length);
                    console.log('‚úÖ Carros J√Å confirmados:', dados.carros.length - carrosNaoConfirmados.length);

                    // S√≥ atualizar lista de pendentes se n√£o h√° carro atual OU se a lista mudou
                    const carroAtualExiste = carroAtual && carrosNaoConfirmados.find(c => c.id === carroAtual.id);

                    if (!carroAtual || !carroAtualExiste) {
                        console.log('üîÑ Atualizando carros pendentes no cron√¥metro...');
                        carrosPendentes = carrosNaoConfirmados.map(carro => ({
                            ...carro
                        }));
                        atualizarListaCarrosPendentes();
                    } else {
                        console.log('‚úÖ Carro atual ainda v√°lido, mantendo cron√¥metro');
                    }

                    let html = '<h4>Total: ' + dados.total + ' carros registrados hoje</h4>';
                    dados.carros.forEach(carro => {
                        const jaSaiu = carro.saida_confirmada; // Agora vem do servidor
                        const isProximo = carroAtual && carroAtual.id === carro.id;

                        console.log(`üöó Carro ${carro.numero}: confirmado=${jaSaiu}, pr√≥ximo=${isProximo}`);

                        let classeCarro = 'carro-item';
                        if (jaSaiu) {
                            classeCarro += ' carro-saiu';
                        } else if (isProximo) {
                            classeCarro += ' proximo-carro';
                        }

                        const statusTexto = jaSaiu ? ' ‚úÖ SAIU' : '';

                        html += `
                            <div class="${classeCarro}" id="carro-${carro.id}">
                                <strong>Carro ${carro.numero}</strong> - ${carro.motorista}
                                - Sa√≠da: ${carro.horario}${statusTexto}
                                <small>(${carro.fiscal} - ${carro.data} - ${carro.linha})</small>
                                <div style="float: right;">
                                    ${!jaSaiu ? `
                                        <button onclick="abrirModalEdicao(${carro.id}, '${carro.fiscal}', '${carro.data}', '${carro.linha}', '${carro.numero}', '${carro.motorista}', '${carro.horario}')" class="editar">‚úèÔ∏è Editar</button>
                                        <button onclick="removerCarro(${carro.id})" class="remover">üóëÔ∏è Remover</button>
                                    ` : '<span style="color: green;">‚úÖ Confirmado</span>'}
                                </div>
                            </div>
                        `;
                    });
                    listaDiv.innerHTML = html;

                    console.log('‚úÖ Lista de carros atualizada no HTML');
                } else {
                    listaDiv.innerHTML = '<p>Nenhum carro registrado hoje ainda.</p>';
                    carrosPendentes = [];
                    carroAtual = null;
                    document.getElementById('cronometroInfo').textContent = 'Nenhum carro agendado';
                    document.getElementById('proximoCarroInfo').style.display = 'none';
                    document.getElementById('cronometroDisplay').textContent = '--:--';
                    console.log('‚ùå Nenhum carro encontrado');
                }
            } catch (error) {
                console.error('‚ùå ERRO ao carregar carros:', error);
                document.getElementById('listaCarros').innerHTML = '<div class="status erro">‚ùå Erro ao carregar: ' + error + '</div>';
            }
        }

        // ========== FUN√á√ïES DE EDI√á√ÉO ==========

        // Abrir modal de edi√ß√£o
        function abrirModalEdicao(id, fiscal, data, linha, numero, motorista, horario) {
            document.getElementById('editId').value = id;
            document.getElementById('editFiscal').value = fiscal;
            document.getElementById('editData').value = data;
            document.getElementById('editLinha').value = linha;
            document.getElementById('editNumero').value = numero;
            document.getElementById('editMotorista').value = motorista;
            document.getElementById('editHorario').value = horario;

            document.getElementById('modalEdicao').style.display = 'block';
        }

        // Fechar modal de edi√ß√£o
        function fecharModalEdicao() {
            document.getElementById('modalEdicao').style.display = 'none';
        }

        // Processar edi√ß√£o
        document.getElementById('formEdicao').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const dados = new URLSearchParams(formData);

            try {
                const response = await fetch('/editar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: dados
                });

                const resultado = await response.json();

                if (resultado.status === 'ok') {
                    fecharModalEdicao();
                    const listaDiv = document.getElementById('listaCarros');
                    listaDiv.innerHTML = '<div class="status sucesso">‚úÖ ' + resultado.mensagem + '</div>' + listaDiv.innerHTML;

                    setTimeout(() => {
                        carregarCarrosSessao();
                        verificarSessao();
                        // Atualizar cron√¥metro ap√≥s edi√ß√£o
                        atualizarListaCarrosPendentes();
                    }, 1000);
                } else {
                    alert('‚ùå ' + resultado.mensagem);
                }
            } catch (error) {
                alert('‚ùå Erro ao editar: ' + error.message);
            }
        });

        // Fechar modal quando clicar fora dele
        window.onclick = function(event) {
            const modal = document.getElementById('modalEdicao');
            if (event.target === modal) {
                fecharModalEdicao();
            }
        }

        // ========== FUN√á√ïES EXISTENTES (mantidas) ==========

        // Fun√ß√£o para finalizar dia
        async function finalizarDia() {
            if (!confirm('üèÅ Tem certeza que deseja finalizar o dia? Isso ir√° "zerar" a prancheta para o pr√≥ximo dia.')) {
                return;
            }

            try {
                const response = await fetch('/finalizar-dia', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: ''
                });

                const resultado = await response.json();

                if (resultado.status === 'ok') {
                    alert('‚úÖ ' + resultado.mensagem);
                    verificarSessao(); // Atualizar info da sess√£o
                    carregarCarrosSessao(); // Atualizar lista
                    // Resetar cron√¥metro
                    resetarCronometro();
                } else {
                    alert('‚ùå ' + resultado.mensagem);
                }
            } catch (error) {
                alert('‚ùå Erro ao finalizar dia: ' + error);
            }
        }

        // Fun√ß√£o para consulta simples por data
        document.getElementById('formConsultaSimples').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const dados = new URLSearchParams(formData);

            try {
                const response = await fetch('/consultar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: dados
                });

                const resultado = await response.json();
                mostrarResultadoConsulta(resultado, 'statusConsultaSimples', 'resultadoConsultaSimples');
            } catch (error) {
                document.getElementById('statusConsultaSimples').innerHTML = '<div class="status erro">‚ùå Erro: ' + error + '</div>';
            }
        });

        // Fun√ß√£o para consulta avan√ßada
        document.getElementById('formConsultaAvancada').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const dados = new URLSearchParams(formData);

            try {
                const response = await fetch('/consultar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: dados
                });

                const resultado = await response.json();
                mostrarResultadoConsulta(resultado, 'statusConsultaAvancada', 'resultadoConsultaAvancada');
            } catch (error) {
                document.getElementById('statusConsultaAvancada').innerHTML = '<div class="status erro">‚ùå Erro: ' + error + '</div>';
            }
        });

        // Fun√ß√£o para mostrar resultado das consultas
        function mostrarResultadoConsulta(resultado, statusId, resultadoId) {
            const statusDiv = document.getElementById(statusId);
            const resultadoDiv = document.getElementById(resultadoId);

            if (resultado.status === 'ok') {
                statusDiv.innerHTML = `<div class="status sucesso">‚úÖ ${resultado.mensagem}</div>`;

                if (resultado.carros.length > 0) {
                    let html = `<h4>üìã Resultados (${resultado.total} carros):</h4>`;
                    resultado.carros.forEach(carro => {
                        html += `
                            <div class="carro-item">
                                <strong>Carro ${carro.numero}</strong> - ${carro.motorista}
                                - Sa√≠da: ${carro.horario}
                                <small>(${carro.fiscal} - ${carro.data} - ${carro.linha})</small>
                                <div style="float: right;">
                                    <button onclick="abrirModalEdicao(${carro.id}, '${carro.fiscal}', '${carro.data}', '${carro.linha}', '${carro.numero}', '${carro.motorista}', '${carro.horario}')" class="editar">‚úèÔ∏è Editar</button>
                                </div>
                            </div>
                        `;
                    });
                    resultadoDiv.innerHTML = html;
                } else {
                    resultadoDiv.innerHTML = '<p>Nenhum registro encontrado para os filtros especificados.</p>';
                }
            } else {
                statusDiv.innerHTML = `<div class="status erro">‚ùå ${resultado.mensagem}</div>`;
                resultadoDiv.innerHTML = '';
            }
        }

        // Fun√ß√£o para estat√≠sticas
        document.getElementById('formEstatisticas').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const dados = new URLSearchParams(formData);

            try {
                const response = await fetch('/estatisticas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: dados
                });

                const resultado = await response.json();
                mostrarEstatisticas(resultado);
            } catch (error) {
                document.getElementById('statusEstatisticas').innerHTML = '<div class="status erro">‚ùå Erro: ' + error + '</div>';
            }
        });

        // Fun√ß√£o para mostrar estat√≠sticas
        function mostrarEstatisticas(resultado) {
            const statusDiv = document.getElementById('statusEstatisticas');
            const resultadoDiv = document.getElementById('resultadoEstatisticas');

            if (resultado.status === 'ok') {
                const stats = resultado.estatisticas;
                statusDiv.innerHTML = `<div class="status sucesso">‚úÖ ${resultado.mensagem}</div>`;

                let html = `
                    <div class="estatistica-item">
                        <h4>üìä Resumo Geral (${stats.periodo.inicio} at√© ${stats.periodo.fim})</h4>
                        <p><strong>Total de Carros:</strong> ${stats.total_carros}</p>
                    </div>
                `;

                if (stats.por_fiscal.length > 0) {
                    html += `<div class="estatistica-item"><h4>üë®‚Äçüíº Por Fiscal:</h4>`;
                    stats.por_fiscal.forEach(item => {
                        html += `<p>‚Ä¢ ${item.fiscal}: ${item.total} carros</p>`;
                    });
                    html += `</div>`;
                }

                if (stats.por_linha.length > 0) {
                    html += `<div class="estatistica-item"><h4>üöå Por Linha:</h4>`;
                    stats.por_linha.forEach(item => {
                        html += `<p>‚Ä¢ ${item.linha}: ${item.total} carros</p>`;
                    });
                    html += `</div>`;
                }

                if (stats.por_dia.length > 0) {
                    html += `<div class="estatistica-item"><h4>üìÖ Por Dia:</h4>`;
                    stats.por_dia.forEach(item => {
                        html += `<p>‚Ä¢ ${item.data}: ${item.total} carros</p>`;
                    });
                    html += `</div>`;
                }

                resultadoDiv.innerHTML = html;
            } else {
                statusDiv.innerHTML = `<div class="status erro">‚ùå ${resultado.mensagem}</div>`;
                resultadoDiv.innerHTML = '';
            }
        }

        // Fun√ß√£o para limpar filtros
        function limparFiltros() {
            document.getElementById('formConsultaAvancada').reset();
            document.getElementById('statusConsultaAvancada').innerHTML = '';
            document.getElementById('resultadoConsultaAvancada').innerHTML = '';
        }

        // Fun√ß√£o para remover carro
        async function removerCarro(id) {
            if (!confirm('Tem certeza que deseja remover este carro?')) {
                return;
            }

            try {
                const response = await fetch('/remover', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `id=${id}`
                });

                const resultado = await response.json();

                if (resultado.status === 'ok') {
                    const listaDiv = document.getElementById('listaCarros');
                    listaDiv.innerHTML = '<div class="status sucesso">‚úÖ ' + resultado.mensagem + '</div>' + listaDiv.innerHTML;
                    setTimeout(() => {
                        carregarCarrosSessao();
                        verificarSessao(); // Atualizar contador
                        // Atualizar cron√¥metro ap√≥s remo√ß√£o
                        atualizarListaCarrosPendentes();
                    }, 1000);
                } else {
                    alert('‚ùå ' + resultado.mensagem);
                }
            } catch (error) {
                alert('‚ùå Erro: ' + error.message);
            }
        }
    </script>
</body>
</html>
